name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write
  security-events: write

env:
  GO_VERSION: '1.24.x'
  BINARY_NAME: 'harborctl'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          # cache é habilitado por padrão; ajudamos com múltiplos caminhos
          cache-dependency-path: |
            go.sum
            **/go.sum
            go.work.sum

      - name: Go vet
        run: go vet ./...

      # Cobertura moderna via GOCOVERDIR (agrega multi-pacote)
      - name: Run tests (race + coverage dir)
        run: |
          set -euo pipefail
          rm -rf cover
          mkdir -p cover
          export GOCOVERDIR="$PWD/cover"
          go test -race ./...
          # Gera coverage.out consolidado se houver dados
          if [ -d "$GOCOVERDIR" ] && [ -n "$(ls -A "$GOCOVERDIR" 2>/dev/null || true)" ]; then
            go tool covdata textfmt -i="$GOCOVERDIR" -o coverage.out
          else
            echo "no coverage data" > coverage.out
          fi

      - name: Govulncheck (oficial)
        uses: golang/govulncheck-action@v1
        continue-on-error: true

      - name: Upload coverage
        if: always() && hashFiles('coverage.out') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out
          if-no-files-found: warn
        continue-on-error: true

  build:
    name: Build Binaries
    needs: test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - os: linux   # Linux amd64
            arch: amd64
            goos: linux
            goarch: amd64
            ext: ""
            archive_ext: tar.gz
          - os: linux   # Linux arm64
            arch: arm64
            goos: linux
            goarch: arm64
            ext: ""
            archive_ext: tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache-dependency-path: |
            go.sum
            **/go.sum
            go.work.sum

      - name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          mkdir -p build dist
          OUT="build/${{ env.BINARY_NAME }}${{ matrix.ext }}"
          go build -trimpath -ldflags="-s -w" -o "$OUT" ./cmd/harborctl

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          ARCHIVE="${{ env.BINARY_NAME }}_${TAG}_${{ matrix.os }}_${{ matrix.arch }}"
          if [[ "${{ matrix.archive_ext }}" == "zip" ]]; then
            (cd build && zip -9 "../dist/${ARCHIVE}.zip" "${{ env.BINARY_NAME }}${{ matrix.ext }}")
          else
            (cd build && tar -czf "../dist/${ARCHIVE}.tar.gz" "${{ env.BINARY_NAME }}${{ matrix.ext }}")
          fi
          ls -lah dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/${{ env.BINARY_NAME }}_${{ github.ref_name }}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz
            dist/${{ env.BINARY_NAME }}_${{ github.ref_name }}_${{ matrix.os }}_${{ matrix.arch }}.zip
          if-no-files-found: ignore
        continue-on-error: true

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
        continue-on-error: true

      - name: Prepare release assets (flatten + checksums)
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          find . -type f -name "*.tar.gz" -exec mv -f {} . \; || true
          find . -type f -name "*.zip"    -exec mv -f {} . \; || true
          find . -mindepth 1 -type d -exec rm -rf {} + || true
          shopt -s nullglob
          files=( *.tar.gz *.zip )
          if (( ${#files[@]} )); then
            sha256sum "${files[@]}" > checksums.txt
          else
            echo "no assets" > checksums.txt
          fi
          ls -lah

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          body: |
            ## Harbor CLI ${{ github.ref_name }}

            ### Instalação rápida

            **Linux (amd64/arm64):**
            ```bash
            OS=linux
            ARCH=$(uname -m); [[ "$ARCH" == "x86_64" ]] && ARCH=amd64
            curl -sSLf https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.BINARY_NAME }}_${{ github.ref_name }}_${OS}_${ARCH}.tar.gz -o ${OS}-${ARCH}.tgz
            tar -xzf ${OS}-${ARCH}.tgz ${BINARY_NAME}
            sudo install -m 0755 ${BINARY_NAME} /usr/local/bin/${BINARY_NAME}
            ${BINARY_NAME} --version
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
